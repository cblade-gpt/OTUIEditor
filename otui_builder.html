<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OTUI Builder 0.1.1 Beta</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-lua.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <link rel="stylesheet" href="otui_builder.css">
    
    <!-- API Configuration - Set this to your server URL, or leave empty to use local functions -->
    <script>
        // Set API base URL (optional - if not set, will use local functions)
        // Example: window.API_BASE_URL = 'http://localhost:3000/api';
        window.API_BASE_URL = 'http://95.217.237.27:3000/api';
    </script>
</head>
<body>
    <div class="app">
        <header class="app-header">
            <div class="header-left"><div class="logo"><span class="logo-icon">OTUI</span><span>Builder 0.1.1 Beta</span></div></div>
            <div class="header-right">
                <button class="btn btn-secondary" id="widgetLibraryBtn" title="Widget Library">Library</button>
                <button class="btn btn-secondary" id="aiGenerateBtn" title="AI Generate Module">AI Generate</button>
                <button class="btn btn-secondary" id="settingsBtn" title="Settings">Settings</button>
                <button class="btn btn-secondary" id="newBtn">New</button>
                <button class="btn btn-accent" id="exportBtn">Export Module</button>
            </div>
        </header>

        <div class="app-body">
            <aside class="sidebar sidebar-left">
                <div class="sidebar-header"><h2>Widgets</h2></div>
                <div class="sidebar-content">
                    <input type="text" id="widgetSearch" placeholder="Search widgets..." style="width: 100%; padding: 0.5rem; margin-bottom: 0.5rem; background: var(--bg-tertiary); border: 1px solid var(--border-primary); border-radius: var(--radius-sm); color: var(--text-primary); font-size: 0.85rem;">
                    <div id="widgetPalette"></div>
                </div>
            </aside>

            <main class="workspace">
                <div class="workspace-toolbar">
                    <button class="btn btn-sm" id="undoBtn" title="Undo (Ctrl+Z)">Undo</button>
                    <button class="btn btn-sm" id="redoBtn" title="Redo (Ctrl+Y)">Redo</button>
                    <div class="toolbar-separator"></div>
                    <button class="btn btn-sm" id="deleteBtn" title="Delete (Del)">Delete</button>
                    <button class="btn btn-sm" id="copyBtn" title="Copy (Ctrl+C)">Copy</button>
                    <button class="btn btn-sm" id="pasteBtn" title="Paste (Ctrl+V)">Paste</button>
                    <button class="btn btn-sm" id="duplicateBtn" title="Duplicate (Ctrl+D)">Duplicate</button>
                    <div class="toolbar-separator"></div>
                    <button class="btn btn-sm" id="gridToggleBtn">Grid</button>
                    <button class="btn btn-sm" id="snapToggleBtn">Snap</button>
                    <div class="toolbar-separator"></div>
                    <button class="btn btn-sm" id="zoomOutBtn">-</button>
                    <span class="zoom-level" id="zoomLevel">100%</span>
                    <button class="btn btn-sm" id="zoomInBtn">+</button>
                    <button class="btn btn-sm" id="zoomResetBtn" title="Reset Zoom">Reset</button>
                    <div class="toolbar-separator"></div>
                    <button class="btn btn-sm btn-accent" id="previewBtn" title="Preview in OTCv8">Preview</button>
                </div>
                <div class="canvas-wrapper">
                    <div class="editor-viewport">
                        <div class="editor-grid" id="editorGrid"></div>
                        <div class="editor-content" id="editorContent"></div>
                    </div>
                </div>
            </main>

            <aside class="sidebar sidebar-right" id="rightSidebar">
                <div class="sidebar-resize-handle" id="rightSidebarResize"></div>
                <div class="sidebar-header">
                    <h2>Properties & Code</h2>
                    <div id="editingIndicator" style="display:none;">Editing: <span id="editingWidgetType"></span></div>
                </div>
                <div class="sidebar-content">
                    <div class="panel">
                        <div class="panel-header"><h3>Properties</h3><div class="panel-badge" id="selectedWidgetBadge">None</div></div>
                        <div class="panel-content" id="propertyForm"><div class="no-selection-message">Select a widget</div></div>
                    </div>
                    <div class="panel">
                        <div class="panel-header"><h3>Hierarchy</h3></div>
                        <div class="panel-content" id="hierarchyTree"></div>
                    </div>
                    <div class="panel">
                        <div class="panel-header"><h3>Code</h3></div>
                        <div class="panel-content">
                            <button class="btn btn-accent" id="viewCodeBtn" style="width: 100%; margin-bottom: 0.5rem;">View Code</button>
                            <button class="btn btn-secondary" id="aiGenerateBtnSidebar" style="width: 100%; margin-bottom: 0.5rem;">AI Generate</button>
                            <label class="btn btn-secondary" style="width: 100%; margin-bottom: 0; cursor: pointer; text-align: center; display: block;">
                                Import OTUI File
                                <input type="file" id="importOTUIFileInput" accept=".otui" style="display: none;">
                            </label>
                        </div>
                    </div>
                </div>
            </aside>
        </div>

        <footer class="app-footer">
            <div>Widgets: <span id="widgetCount">0</span></div>
        </footer>
    </div>

    <div id="moduleCreatorModal" class="modal" style="display:none;">
        <div class="modal-content">
            <div class="modal-header"><h2>Export Module</h2><button class="modal-close" aria-label="Close">√ó</button></div>
            <div class="modal-body">
                <div class="form-group"><label>Name:</label><input id="moduleName" value="main" placeholder="Module name (e.g., main)"></div>
                <div class="form-group"><label>Title:</label><input id="moduleTitle" value="My Module" placeholder="Module title"></div>
                <div class="form-group"><label>Description:</label><input id="moduleDescription" value="" placeholder="Module description"></div>
                <div class="form-group"><label>Author:</label><input id="moduleAuthor" value="" placeholder="Author name"></div>
                <div class="form-group"><label>Website:</label><input id="moduleWebsite" value="" placeholder="Website URL (optional)"></div>
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 8px;">
                        <input type="checkbox" id="moduleSandboxed" checked style="width: auto;">
                        <span>Sandboxed</span>
                    </label>
                </div>
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 8px;">
                        <input type="checkbox" id="moduleAutoload" checked style="width: auto;">
                        <span>Autoload</span>
                    </label>
                </div>
                <button class="btn btn-accent" id="exportAllBtn" style="width: 100%; margin-top: 10px;">Export ZIP</button>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <!-- Cookie Consent Dialog -->
    <div id="cookieConsentDialog" class="cookie-consent" style="display: none;">
        <div class="cookie-consent-content">
            <div class="cookie-consent-header">
                <h3>üç™ Cookie Consent</h3>
            </div>
            <div class="cookie-consent-body">
                <p>We use cookies to:</p>
                <ul>
                    <li>üíæ Save your widget templates for reuse</li>
                    <li>üìù Auto-save your canvas progress</li>
                    <li>‚öôÔ∏è Remember your preferences and settings</li>
                </ul>
                <p style="margin-top: 10px; font-size: 0.9rem; color: #94a3b8;">
                    Cookies are stored locally in your browser and never sent to any server.
                </p>
            </div>
            <div class="cookie-consent-actions">
                <button class="btn btn-accent" id="acceptCookiesBtn">Accept Cookies</button>
                <button class="btn btn-secondary" id="declineCookiesBtn">Decline</button>
            </div>
        </div>
    </div>

    <!-- Widget Library Modal -->
    <div id="widgetLibraryModal" class="modal" style="display:none;">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h2>üìö Widget Library</h2>
                <button class="modal-close" aria-label="Close">√ó</button>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 20px;">
                    <h3 style="font-size: 0.95rem; margin-bottom: 10px; color: var(--text-primary); font-weight: 600;">Save Current Widget</h3>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="saveWidgetNameInput" placeholder="Template name (e.g., CustomButton)" style="flex: 1; padding: 8px; background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border-primary); border-radius: 4px;">
                        <button class="btn btn-accent" id="saveWidgetBtn">Save</button>
                    </div>
                    <small style="color: #94a3b8; display: block; margin-top: 6px;">
                        Save the currently selected widget (and its children) as a reusable template.
                    </small>
                </div>
                
                <div style="border-top: 1px solid var(--border-primary); padding-top: 20px;">
                    <h3 style="font-size: 0.95rem; margin-bottom: 15px; color: var(--text-primary); font-weight: 600;">Saved Templates</h3>
                    <div id="widgetTemplatesList" style="max-height: 400px; overflow-y: auto;">
                        <div class="no-templates" style="text-align: center; padding: 40px; color: #94a3b8;">
                            <p>No saved templates yet.</p>
                            <p style="font-size: 0.85rem; margin-top: 10px;">Select a widget and save it to create your first template!</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="previewModal" class="modal" style="display:none;">
        <div class="modal-content" style="max-width: 95vw; width: 1200px; height: 90vh;">
            <div class="modal-header">
                <h2>OTCv8 Preview</h2>
                <button class="modal-close" aria-label="Close">√ó</button>
            </div>
            <div class="modal-body" style="padding: 0; height: calc(90vh - 80px); overflow: hidden; background: #000000;">
                <div id="otcv8Preview" style="width: 100%; height: 100%; position: relative; background: #000000; display: flex; align-items: center; justify-content: center; overflow: auto; padding: 20px;">
                    <div id="previewWindow" style="position: relative; background: #000000; min-width: 800px; min-height: 600px; margin: auto; border: none;"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="codeModal" class="modal" style="display:none;">
        <div class="modal-content code-modal-content">
            <div class="modal-header">
                <h2>Generated Code</h2>
                <button class="modal-close" aria-label="Close">√ó</button>
            </div>
            <div class="modal-body code-modal-body">
                <div class="code-tabs">
                    <button class="code-tab active" data-tab="otui">OTUI</button>
                    <button class="code-tab" data-tab="lua">LUA</button>
                    <button class="code-tab" data-tab="otmod">OTMOD</button>
                </div>
                <div class="code-modal-content-wrapper">
                    <pre id="otuiCode" class="code-block language-otui active" style="display: block;"><code></code></pre>
                    <pre id="luaCode" class="code-block language-lua" style="display: none;"><code></code></pre>
                    <pre id="otmodCode" class="code-block language-otmod" style="display: none;"><code></code></pre>
                </div>
            </div>
        </div>
    </div>

    <div id="settingsModal" class="modal" style="display:none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Settings</h2>
                <button class="modal-close" aria-label="Close">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label style="font-weight: 600; margin-bottom: 8px; display: block;">Step 1: Load .otui Style Files</label>
                    <input type="file" id="otuiFilesInput" multiple accept=".otui" style="width: 100%; padding: 8px; margin-top: 4px; background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border-primary); border-radius: 4px; cursor: pointer;">
                    <small style="color: #94a3b8; display: block; margin-top: 6px;">
                        Select all .otui files from your <code>data/styles</code> folder (Ctrl+A or Ctrl+Click to select multiple).
                    </small>
                </div>
                <div class="form-group" style="margin-top: 20px;">
                    <label style="font-weight: 600; margin-bottom: 8px; display: block;">Step 2: Load Images Folder</label>
                    <input type="file" id="imagesFilesInput" multiple accept="image/*" webkitdirectory directory style="width: 100%; padding: 8px; margin-top: 4px; background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border-primary); border-radius: 4px; cursor: pointer;">
                    <small style="color: #94a3b8; display: block; margin-top: 6px;">
                        Select your <code>data/images</code> folder (or all image files). This ensures UI objects display correctly with images.
                    </small>
                </div>
                <div id="settingsStatus" style="margin-top: 10px; padding: 8px; border-radius: 4px; display: none;"></div>
            </div>
        </div>
    </div>

    <div id="aiGenerateModal" class="modal" style="display:none;">
        <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h2>‚ú® AI Module Generator</h2>
                <button class="modal-close" aria-label="Close">√ó</button>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid var(--border-primary);">
                    <h3 style="font-size: 0.95rem; margin-bottom: 15px; color: var(--text-primary); font-weight: 600;">‚öôÔ∏è AI Settings</h3>
                    <div class="form-group">
                        <label style="font-weight: 600; margin-bottom: 8px; display: block;">AI Provider</label>
                        <select id="aiProviderSelect" style="width: 100%; padding: 8px; background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border-primary); border-radius: 4px;">
                            <optgroup label="Free Providers">
                                <option value="groq">Groq (Free - Very Fast)</option>
                                <option value="gemini">Google Gemini (Free)</option>
                                <option value="huggingface">Hugging Face (Free)</option>
                                <option value="openrouter">OpenRouter (Free Models)</option>
                            </optgroup>
                            <optgroup label="Paid Providers">
                                <option value="openai">OpenAI (GPT-4, GPT-3.5)</option>
                                <option value="anthropic">Anthropic (Claude)</option>
                            </optgroup>
                            <optgroup label="Local/Self-Hosted">
                                <option value="ollama">Ollama (Local)</option>
                                <option value="local">Custom API Endpoint</option>
                            </optgroup>
                        </select>
                        <small style="color: #94a3b8; display: block; margin-top: 6px;">
                            <strong>Free options:</strong> Groq (fastest), Gemini, Hugging Face, OpenRouter. Get API keys from their websites.
                        </small>
                    </div>
                    <div class="form-group" style="margin-top: 15px;">
                        <label style="font-weight: 600; margin-bottom: 8px; display: block;">API Key</label>
                        <input type="password" id="aiApiKeyInput" placeholder="Enter your API key" style="width: 100%; padding: 8px; background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border-primary); border-radius: 4px;">
                        <small style="color: #94a3b8; display: block; margin-top: 6px;">
                            Your API key is stored locally and never sent to our servers.
                        </small>
                    </div>
                    <div class="form-group" style="margin-top: 15px;">
                        <label style="font-weight: 600; margin-bottom: 8px; display: block;">Model Name</label>
                        <input type="text" id="aiModelInput" placeholder="See suggestions below" style="width: 100%; padding: 8px; background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border-primary); border-radius: 4px;">
                        <small style="color: #94a3b8; display: block; margin-top: 6px;">
                            <strong>Suggestions:</strong><br>
                            Groq: llama-3.1-8b-instant, mixtral-8x7b-32768<br>
                            Gemini: gemini-pro, gemini-pro-vision<br>
                            Hugging Face: mistralai/Mistral-7B-Instruct-v0.2<br>
                            OpenRouter: google/gemini-flash-1.5, meta-llama/llama-3.1-8b-instruct<br>
                            OpenAI: gpt-4o-mini, gpt-3.5-turbo<br>
                            Anthropic: claude-3-haiku-20240307
                        </small>
                    </div>
                    <div class="form-group" id="aiEndpointGroup" style="margin-top: 15px; display: none;">
                        <label style="font-weight: 600; margin-bottom: 8px; display: block;">API Endpoint (for Ollama/Local)</label>
                        <input type="text" id="aiEndpointInput" placeholder="http://localhost:11434" style="width: 100%; padding: 8px; background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border-primary); border-radius: 4px;">
                    </div>
                    <button class="btn btn-accent" id="saveAISettingsBtn" style="width: 100%; margin-top: 15px;">Save AI Settings</button>
                </div>
                
                <div class="form-group">
                    <label style="font-weight: 600; margin-bottom: 8px; display: block;">Describe what you want to create:</label>
                    <textarea id="aiDescriptionInput" placeholder="Example: Create a health bar widget with a red background, showing percentage text, size 200x30 pixels" rows="4" style="width: 100%; padding: 10px; background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border-primary); border-radius: 4px; font-family: inherit; resize: vertical;"></textarea>
                    <small style="color: #94a3b8; display: block; margin-top: 6px;">
                        Be specific about widget types, sizes, colors, and layout. The AI will use your loaded OTUI styles as context.
                    </small>
                </div>
                <div id="aiProgress" style="display: none; margin-top: 15px; padding: 12px; background: var(--bg-tertiary); border-radius: 4px; color: var(--text-secondary); font-size: 0.9rem;"></div>
                <div id="aiGeneratedCode" style="display: none; margin-top: 15px;">
                    <label style="font-weight: 600; margin-bottom: 8px; display: block;">Generated Code:</label>
                    <pre id="aiCodePreview" style="background: var(--bg-code); padding: 12px; border-radius: 4px; overflow-x: auto; max-height: 300px; font-size: 0.85rem; color: var(--text-primary); border: 1px solid var(--border-primary);"></pre>
                    <div style="margin-top: 15px; display: flex; gap: 10px;">
                        <button class="btn btn-accent" id="aiApplyCodeBtn">Apply to Canvas</button>
                        <button class="btn btn-secondary" id="aiCopyCodeBtn">Copy Code</button>
                        <button class="btn btn-secondary" id="aiRegenerateBtn">Regenerate</button>
                    </div>
                </div>
                <div style="margin-top: 20px; display: flex; gap: 10px;">
                    <button class="btn btn-accent" id="aiGenerateBtnModal" style="flex: 1;">Generate</button>
                    <button class="btn btn-secondary" id="aiCancelBtn">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <script src="otui_builder.js"></script>
</body>
</html>